# a build with no CI
trigger: none

jobs:
- job: NetCore_Services_Kubernetes
  pool:
    name: Hosted Ubuntu 1604

  variables:
    BuildConfiguration: WebCore
    BuildPlatform: Any CPU
    BuildType: Container
    NamePrefix_local: $(NamePrefix)
    SubscriptionId_local: $(SubscriptionId)
    ConnectedServiceName_local: $(ConnectedServiceName)

  steps:
  - task: Docker@0
    displayName: 'Build a container image'
    inputs:
      imageName: 'acrcontosotravel${{ variables.NamePrefix_local }}.azurecr.io/contoso-travel-service:$(Build.BuildId)'
      includeLatestTag: true
      dockerFile: src/ServicesDockerFile
      workingDirectory: '$(build.sourcesDirectory)/src'
      buildArguments: IsWebJob=false
    condition: and(always(), ne(variables['eventing'], 'servicebus'))

  - task: Docker@0
    displayName: 'Build a container image'
    inputs:
      imageName: 'acrcontosotravel${{ variables.NamePrefix_local }}.azurecr.io/contoso-travel-service:$(Build.BuildId)'
      includeLatestTag: true
      dockerFile: src/ServicesDockerFile
      workingDirectory: '$(build.sourcesDirectory)/src'
      buildArguments: IsWebJob=true
    condition: and(always(), eq(variables['eventing'], 'servicebus'))

  - task: Docker@0
    displayName: 'Push a container image'
    inputs:
      azureSubscription: '${{ variables.ConnectedServiceName_local }}'
      azureContainerRegistry: '{"loginServer":"acrcontosotravel${{ variables.NamePrefix_local }}.azurecr.io", "id":"/subscriptions/${{ variables.SubscriptionId_local }}/resourceGroups/rg-${{ variables.NamePrefix_local }}/providers/Microsoft.ContainerRegistry/registries/acrContosoTravel${{ variables.NamePrefix_local }}"}'
      action: 'Push an image'
      includeLatestTag: true
      imageName: 'acrcontosotravel${{ variables.NamePrefix_local }}.azurecr.io/contoso-travel-service:$(Build.BuildId)'
      workingDirectory: '$(build.sourcesDirectory)/src'

  - task: AzureCLI@1
    displayName: 'Azure CLI - Set Variables for Kubernetes'
    inputs:
      azureSubscription: '${{ variables.ConnectedServiceName_local }}'
      scriptLocation: inlineScript
      inlineScript: |
        "Get Info From Resource Group - appInsightsKey"
        $appInsightsKey = az resource show --resource-group rg-${{ variables.NamePrefix_local }} --subscription ${{ variables.SubscriptionId_local }} --resource-type Microsoft.Insights/components --name ${{ variables.NamePrefix_local }}appInsightContosoTravel --query "properties.InstrumentationKey"
        "Get Info From Resource Group - dnsZone"
        $dnsZone = (az aks show --resource-group rg-${{ variables.NamePrefix_local }} --subscription ${{ variables.SubscriptionId_local }} --name aks-ContosoTravel-${{ variables.NamePrefix_local }} --query addonProfiles.httpApplicationRouting.config.HTTPApplicationRoutingZoneName).Replace('"', '')
        "Get Info serviceConnStr Resource Group - dnsZone"
        $serviceConnStr = ((az keyvault secret show --subscription ${{ variables.SubscriptionId_local }} --vault-name "kv${{ variables.NamePrefix_local }}" --name "ContosoTravel--EventingConnectionString" --query value).Replace('"', '')) -replace ";EntityPath.+", ""
        echo "##vso[task.setvariable variable=appInsightsKey;isOutput=true]$appInsightsKey"
        echo "##vso[task.setvariable variable=dnsZone;isOutput=true]$dnsZone"
        echo "##vso[task.setvariable variable=serviceConnStr;isOutput=true]$serviceConnStr"
    name: 'azureValues'

  - task: qetza.replacetokens.replacetokens-task.replacetokens@3
    displayName: 'Replace tokens in webDeploy.yaml'
    inputs:
      targetFiles: src/serviceDeploy.yaml
  
  - task: AzureCLI@1
    displayName: 'Azure CLI - Set Variables for Kubernetes'
    inputs:
      azureSubscription: '${{ variables.ConnectedServiceName_local }}'
      scriptLocation: inlineScript
      inlineScript: |
      az aks get-credentials --subscription ${{ variables.SubscriptionId_local }} --resource-group ${{ variables.ResourceGroupName_local }} --name aks-ContosoTravel-${{ variables.NamePrefix_local }} --overwrite-existing
      kubectl apply -f src/serviceDeploy.yaml
      kubectl set image deployments/contosotravel-service contosotravel-service=acrContosoTravel${{ variables.NamePrefix_local }}.azurecr.io/contoso-service-web:${{ build.buildId }}
