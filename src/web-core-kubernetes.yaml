# a build with no CI
trigger: none

variables:
  BuildConfiguration: WebCore
  BuildPlatform: Any CPU
  BuildType: Container

jobs:
- job: NetCore_Web_Build_and_Deploy
  pool:
    name: Hosted VS2017
    demands: 
    - msbuild
    - visualstudio
    - vstest
  steps:
  - template: ./build.yaml
    parameters:
      ConnectedServiceName: $(ConnectedServiceName)

  - powershell: |
     mkdir (join-path $env:TEMP -ChildPath arkhitekton-modules)
    displayName: 'mkdir arkhitekton-modules'

  - powershell: |
     $dir = (join-path $env:TEMP -ChildPath arkhitekton-modules)
     cd $dir
     $repoUrl = $env:REPO_URI.Replace('contosotravel-web-dotnet', 'arkhitekton-modules')
     "$repoUrl"
     git init $dir
     git remote add origin $repoUrl
     git config gc.auto 0
     git config --get-all "http.$($repoUrl).extraheader"
     git config --get-all http.proxy
     git -c http.extraheader="AUTHORIZATION: bearer $env:SYSTEM_ACCESSTOKEN" fetch --tags --prune --progress --no-recurse-submodules origin
     git checkout origin/master
     ls $dir/*
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
      REPO_URI: $(Build.Repository.Uri)
    displayName: 'Get latest on modules repo'
  
  - task: HelmInstaller@0
    displayName: 'Install Helm 2.9.1'
    inputs:
      kubectlVersion: 1.10.3
      checkLatestKubectl: true

  - task: AzureCLI@1
    displayName: 'Azure CLI - Running configuration.ps1 and Deploy'
    inputs:
      azureSubscription: '${{ parameters.ConnectedServiceName }}'
      scriptPath: C:\Users\VssAdministrator\AppData\Local\Temp\arkhitekton-modules\configure.ps1
      arguments: '-rg rg-${{ parameters.NamePrefix }} -sub ${{ parameters.SubscriptionId }} -namePrefix ${{ parameters.NamePrefix }} -pathToDeploy webdeploy.yaml -includeNginx'
      workingDirectory: src\Host.MVC.Core\
